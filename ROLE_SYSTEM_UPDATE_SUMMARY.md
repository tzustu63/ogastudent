# è§’è‰²ç³»çµ±æ›´æ–°ç¸½çµ

## ğŸ“‹ æ›´æ–°å…§å®¹

æ ¹æ“šéœ€æ±‚é€²è¡Œäº†ä»¥ä¸‹å››é …ä¸»è¦ä¿®æ”¹ï¼š

### 1. âœ… åˆªé™¤å­¸ç”Ÿè§’è‰²

**å¾Œç«¯ä¿®æ”¹ï¼š**
- `backend/src/models/user.ts`
  - å¾ `UserRole` enum ä¸­ç§»é™¤ `STUDENT = 'student'`
  - ç§»é™¤ `isStudent()` æ–¹æ³•
  - é è¨­è§’è‰²æ”¹ç‚º `UNIT_STAFF`
  - æ›´æ–°è§’è‰²é¡¯ç¤ºåç¨±å°æ‡‰è¡¨

**å½±éŸ¿ï¼š**
- ç³»çµ±ç¾åœ¨åªæœ‰ 3 å€‹è§’è‰²ï¼š`admin`ã€`unit_staff`ã€`auditor`
- æ‰€æœ‰æ–°ä½¿ç”¨è€…é è¨­ç‚ºå–®ä½è·å“¡

---

### 2. âœ… ç³»çµ±ç®¡ç†å“¡å¯ä»¥ç®¡ç†ä½¿ç”¨è€…å¸³è™Ÿ

**æ–°å¢æª”æ¡ˆï¼š**
- `backend/src/controllers/user.controller.ts` - ä½¿ç”¨è€…ç®¡ç†æ§åˆ¶å™¨
- `backend/src/services/user.service.ts` - ä½¿ç”¨è€…ç®¡ç†æœå‹™
- `backend/src/routes/user.routes.ts` - ä½¿ç”¨è€…ç®¡ç†è·¯ç”±

**API ç«¯é»ï¼š**

| æ–¹æ³• | è·¯å¾‘ | åŠŸèƒ½ | æ¬Šé™ |
|------|------|------|------|
| GET | `/api/users` | å–å¾—ä½¿ç”¨è€…åˆ—è¡¨ | åƒ…ç®¡ç†å“¡ |
| GET | `/api/users/:id` | å–å¾—å–®ä¸€ä½¿ç”¨è€… | ç®¡ç†å“¡æˆ–æœ¬äºº |
| POST | `/api/users` | å‰µå»ºæ–°ä½¿ç”¨è€… | åƒ…ç®¡ç†å“¡ |
| PUT | `/api/users/:id` | æ›´æ–°ä½¿ç”¨è€… | ç®¡ç†å“¡æˆ–æœ¬äºº |
| DELETE | `/api/users/:id` | åˆªé™¤ä½¿ç”¨è€… | åƒ…ç®¡ç†å“¡ |
| POST | `/api/users/:id/reset-password` | é‡è¨­å¯†ç¢¼ | ç®¡ç†å“¡æˆ–æœ¬äºº |

**å‰µå»ºä½¿ç”¨è€… API ç¯„ä¾‹ï¼š**
```json
POST /api/users
{
  "username": "john_doe",
  "email": "john@example.com",
  "name": "John Doe",
  "password": "secure_password",
  "role": "unit_staff",
  "unit_id": "global_affairs"
}
```

**åŠŸèƒ½ç‰¹é»ï¼š**
- âœ… ç®¡ç†å“¡å¯ä»¥å‰µå»º `unit_staff` æˆ– `auditor` è§’è‰²
- âœ… å‰µå»ºå–®ä½è·å“¡æ™‚å¿…é ˆæŒ‡å®š `unit_id`
- âœ… è‡ªå‹•é©—è­‰ä½¿ç”¨è€…åç¨±å’Œé›»å­éƒµä»¶å”¯ä¸€æ€§
- âœ… å¯†ç¢¼è‡ªå‹•åŠ å¯†ï¼ˆbcryptï¼‰
- âœ… ä¸èƒ½åˆªé™¤è‡ªå·±çš„å¸³è™Ÿ

---

### 3. âœ… å–®ä½è·å“¡æ¬Šé™èª¿æ•´

**ä¿®æ”¹æª”æ¡ˆï¼š**
- `backend/src/models/user.ts`

**æ–°å¢æ–¹æ³•ï¼š**
```typescript
// æª¢æŸ¥æ˜¯å¦å¯ä»¥å­˜å–ç‰¹å®šå–®ä½çš„è³‡æ–™
canAccessUnit(unitId: string): boolean {
  // ç®¡ç†å“¡ã€ç¨½æ ¸äººå“¡å’Œå–®ä½è·å“¡éƒ½å¯ä»¥å­˜å–æ‰€æœ‰å–®ä½è³‡æ–™
  return this.isAdmin() || this.isAuditor() || this.isUnitStaff();
}

// æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¸Šå‚³ç‰¹å®šå–®ä½çš„æ–‡ä»¶
canUploadForUnit(unitId: string): boolean {
  // ç®¡ç†å“¡å¯ä»¥ä¸Šå‚³æ‰€æœ‰å–®ä½çš„æ–‡ä»¶
  if (this.isAdmin()) {
    return true;
  }
  
  // å–®ä½è·å“¡åªèƒ½ä¸Šå‚³è‡ªå·±å–®ä½çš„æ–‡ä»¶
  if (this.isUnitStaff()) {
    return this.unit_id === unitId;
  }
  
  // ç¨½æ ¸äººå“¡ä¸èƒ½ä¸Šå‚³æ–‡ä»¶
  return false;
}
```

**æ¬Šé™è®Šæ›´ï¼š**

| åŠŸèƒ½ | åŸæœ¬ | ç¾åœ¨ |
|------|------|------|
| æŸ¥çœ‹æ‰€æœ‰å­¸ç”Ÿè³‡æ–™ | âŒ åªèƒ½çœ‹è‡ªå·±å–®ä½ | âœ… å¯ä»¥çœ‹æ‰€æœ‰è³‡æ–™ |
| ä¸Šå‚³æ–‡ä»¶ | âœ… è‡ªå·±å–®ä½ | âœ… è‡ªå·±å–®ä½ |
| å¯©æ ¸æ–‡ä»¶ | âŒ | âŒ ä¸å…·å‚™ |

---

### 4. âœ… ç¨½æ ¸äººå“¡æ¬Šé™èª¿æ•´

**ä¿®æ”¹æª”æ¡ˆï¼š**
- `backend/src/models/user.ts`
- `frontend/src/pages/StudentDetailPage.tsx`
- `frontend/src/components/Navigation.tsx`

**æ–°å¢æ–¹æ³•ï¼š**
```typescript
// æª¢æŸ¥æ˜¯å¦å¯ä»¥å¯©æ ¸æ–‡ä»¶
canReviewDocuments(): boolean {
  // åªæœ‰ç¨½æ ¸äººå“¡å’Œç®¡ç†å“¡å¯ä»¥å¯©æ ¸æ–‡ä»¶
  return this.isAuditor() || this.isAdmin();
}
```

**å‰ç«¯æ¬Šé™æ›´æ–°ï¼š**
```typescript
// StudentDetailPage.tsx
const canUpdateStatus = user?.role === 'admin' || user?.role === 'auditor';
```

**æ¬Šé™è®Šæ›´ï¼š**

| åŠŸèƒ½ | åŸæœ¬ | ç¾åœ¨ |
|------|------|------|
| æŸ¥çœ‹æ‰€æœ‰è³‡æ–™ | âœ… | âœ… å”¯è®€ |
| æŸ¥çœ‹å ±è¡¨ | âœ… | âœ… |
| åŒ¯å‡ºå ±è¡¨ | âœ… | âœ… |
| å¯©æ ¸æ–‡ä»¶ | âŒ | âœ… **æ–°å¢** |
| ä¸Šå‚³æ–‡ä»¶ | âŒ | âŒ |
| ä¿®æ”¹è³‡æ–™ | âŒ | âŒ |

---

## ğŸ¯ æœ€çµ‚è§’è‰²æ¬Šé™çŸ©é™£

### ç³»çµ±ç®¡ç†å“¡ (admin)

| åŠŸèƒ½é¡åˆ¥ | æ¬Šé™ |
|---------|------|
| ä½¿ç”¨è€…ç®¡ç† | âœ… å‰µå»ºã€ç·¨è¼¯ã€åˆªé™¤ä½¿ç”¨è€… |
| å­¸ç”Ÿç®¡ç† | âœ… å®Œæ•´æ¬Šé™ |
| æ–‡ä»¶ç®¡ç† | âœ… ä¸Šå‚³æ‰€æœ‰å–®ä½æ–‡ä»¶ |
| æ–‡ä»¶å¯©æ ¸ | âœ… æ›´æ–°æ–‡ä»¶ç‹€æ…‹ |
| å ±è¡¨æŸ¥çœ‹ | âœ… æ‰€æœ‰å ±è¡¨ |
| ç³»çµ±è¨­å®š | âœ… å®Œæ•´æ¬Šé™ |

### å–®ä½è·å“¡ (unit_staff)

| åŠŸèƒ½é¡åˆ¥ | æ¬Šé™ |
|---------|------|
| ä½¿ç”¨è€…ç®¡ç† | âŒ |
| å­¸ç”Ÿç®¡ç† | âœ… æŸ¥çœ‹æ‰€æœ‰å­¸ç”Ÿè³‡æ–™ |
| æ–‡ä»¶ç®¡ç† | âœ… ä¸Šå‚³æ‰€å±¬å–®ä½æ–‡ä»¶ |
| æ–‡ä»¶å¯©æ ¸ | âŒ ä¸å…·å‚™å¯©æ ¸åŠŸèƒ½ |
| å ±è¡¨æŸ¥çœ‹ | âŒ |
| ç³»çµ±è¨­å®š | âŒ |

### ç¨½æ ¸äººå“¡ (auditor)

| åŠŸèƒ½é¡åˆ¥ | æ¬Šé™ |
|---------|------|
| ä½¿ç”¨è€…ç®¡ç† | âŒ |
| å­¸ç”Ÿç®¡ç† | âœ… æŸ¥çœ‹æ‰€æœ‰å­¸ç”Ÿè³‡æ–™ï¼ˆå”¯è®€ï¼‰ |
| æ–‡ä»¶ç®¡ç† | âœ… æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶ï¼ˆå”¯è®€ï¼‰ |
| æ–‡ä»¶å¯©æ ¸ | âœ… **æ›´æ–°æ–‡ä»¶ç‹€æ…‹** |
| å ±è¡¨æŸ¥çœ‹ | âœ… æ‰€æœ‰å ±è¡¨ |
| ç³»çµ±è¨­å®š | âŒ |

---

## ğŸ”„ å°èˆªé¸å–®æ›´æ–°

**å‰ç«¯ä¿®æ”¹ï¼š** `frontend/src/components/Navigation.tsx`

```typescript
// æ‰€æœ‰è§’è‰²éƒ½å¯ä»¥çœ‹åˆ°
- é¦–é 
- å­¸ç”Ÿç®¡ç†
- æ–‡ä»¶ç®¡ç†  // æ–°å¢ï¼šåŸæœ¬å­¸ç”Ÿçœ‹ä¸åˆ°
- é€šçŸ¥

// ç®¡ç†å“¡å’Œç¨½æ ¸äººå“¡å¯ä»¥çœ‹åˆ°
if (user?.role === 'admin' || user?.role === 'auditor') {
  - å ±è¡¨çµ±è¨ˆ  // æ›´æ–°ï¼šåŸæœ¬æ˜¯ admin æˆ– unit_manager
}

// åªæœ‰ç®¡ç†å“¡å¯ä»¥çœ‹åˆ°
if (user?.role === 'admin') {
  - ç³»çµ±è¨­å®š
}
```

---

## ğŸ“ ä½¿ç”¨æƒ…å¢ƒ

### æƒ…å¢ƒ 1ï¼šç®¡ç†å“¡å‰µå»ºå–®ä½è·å“¡å¸³è™Ÿ

```bash
POST /api/users
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "username": "global_affairs_staff",
  "email": "staff@global.edu.tw",
  "name": "å…¨çƒè™•è·å“¡",
  "password": "SecurePass123",
  "role": "unit_staff",
  "unit_id": "global_affairs"
}
```

### æƒ…å¢ƒ 2ï¼šç®¡ç†å“¡å‰µå»ºç¨½æ ¸äººå“¡å¸³è™Ÿ

```bash
POST /api/users
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "username": "auditor_wang",
  "email": "wang@audit.edu.tw",
  "name": "ç‹ç¨½æ ¸",
  "password": "SecurePass123",
  "role": "auditor"
}
```

### æƒ…å¢ƒ 3ï¼šå–®ä½è·å“¡ä¸Šå‚³æ–‡ä»¶

1. ä»¥ `unit_staff` è§’è‰²ç™»å…¥ï¼ˆunit_id: `registration`ï¼‰
2. é€²å…¥ä»»ä½•å­¸ç”Ÿè©³æƒ…é é¢ï¼ˆå¯ä»¥çœ‹æ‰€æœ‰å­¸ç”Ÿï¼‰
3. åªèƒ½ä¸Šå‚³è¨»å†Šçµ„è² è²¬çš„æ–‡ä»¶é¡å‹
4. **ç„¡æ³•æ›´æ–°æ–‡ä»¶ç‹€æ…‹**

### æƒ…å¢ƒ 4ï¼šç¨½æ ¸äººå“¡å¯©æ ¸æ–‡ä»¶

1. ä»¥ `auditor` è§’è‰²ç™»å…¥
2. é€²å…¥ä»»ä½•å­¸ç”Ÿè©³æƒ…é é¢
3. å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶
4. é»æ“Šã€Œæ›´æ–°ç‹€æ…‹ã€æŒ‰éˆ•
5. é¸æ“‡ç‹€æ…‹ï¼šå¾…å¯©æ ¸ â†’ å·²æ ¸å‡†/å·²æ‹’çµ•
6. **ç„¡æ³•ä¸Šå‚³æ–°æ–‡ä»¶**

---

## ğŸ—„ï¸ è³‡æ–™åº«è®Šæ›´

**ä¸éœ€è¦ä¿®æ”¹è³‡æ–™åº«çµæ§‹**ï¼Œä½†éœ€è¦ï¼š

1. **æ¸…ç†ç¾æœ‰å­¸ç”Ÿè§’è‰²ä½¿ç”¨è€…**ï¼ˆå¦‚æœæœ‰ï¼‰ï¼š
```sql
-- æŸ¥çœ‹æ˜¯å¦æœ‰å­¸ç”Ÿè§’è‰²çš„ä½¿ç”¨è€…
SELECT * FROM users WHERE role = 'student';

-- åˆªé™¤æˆ–è½‰æ›å­¸ç”Ÿè§’è‰²ä½¿ç”¨è€…
DELETE FROM users WHERE role = 'student';
-- æˆ–
UPDATE users SET role = 'unit_staff' WHERE role = 'student';
```

2. **ç¢ºä¿æ‰€æœ‰ unit_staff éƒ½æœ‰ unit_id**ï¼š
```sql
-- æª¢æŸ¥æ²’æœ‰ unit_id çš„å–®ä½è·å“¡
SELECT * FROM users WHERE role = 'unit_staff' AND unit_id IS NULL;

-- æ›´æ–°æˆ–åˆªé™¤é€™äº›è¨˜éŒ„
UPDATE users SET unit_id = 'default_unit' WHERE role = 'unit_staff' AND unit_id IS NULL;
```

---

## âš ï¸ æ³¨æ„äº‹é …

### 1. å‰å¾Œç«¯è§’è‰²åç¨±ä¸€è‡´æ€§

ç¢ºä¿å‰ç«¯ä½¿ç”¨çš„è§’è‰²åç¨±èˆ‡å¾Œç«¯ä¸€è‡´ï¼š
- âœ… `admin` - ç³»çµ±ç®¡ç†å“¡
- âœ… `unit_staff` - å–®ä½è·å“¡
- âœ… `auditor` - ç¨½æ ¸äººå“¡
- âŒ ~~`student`~~ - å·²ç§»é™¤
- âŒ ~~`reviewer`~~ - ä¸ä½¿ç”¨ï¼Œæ”¹ç”¨ `auditor`
- âŒ ~~`unit_manager`~~ - ä¸ä½¿ç”¨ï¼Œæ”¹ç”¨ `auditor`

### 2. å–®ä½è·å“¡å¿…é ˆæœ‰ unit_id

å‰µå»ºæˆ–æ›´æ–°ç‚º `unit_staff` è§’è‰²æ™‚ï¼Œå¿…é ˆæä¾› `unit_id`ï¼Œå¦å‰‡æœƒé©—è­‰å¤±æ•—ã€‚

### 3. æ¬Šé™æª¢æŸ¥

- å‰ç«¯æª¢æŸ¥ç”¨æ–¼ UI é¡¯ç¤ºï¼ˆéš±è—æŒ‰éˆ•ç­‰ï¼‰
- å¾Œç«¯æª¢æŸ¥ç”¨æ–¼å®‰å…¨é˜²è­·ï¼ˆAPI æ¬Šé™é©—è­‰ï¼‰
- å…©è€…éƒ½å¿…é ˆå¯¦ä½œ

### 4. æ–‡ä»¶å¯©æ ¸æ¬Šé™

ç¾åœ¨åªæœ‰ä»¥ä¸‹è§’è‰²å¯ä»¥æ›´æ–°æ–‡ä»¶ç‹€æ…‹ï¼š
- âœ… ç³»çµ±ç®¡ç†å“¡ (`admin`)
- âœ… ç¨½æ ¸äººå“¡ (`auditor`)
- âŒ å–®ä½è·å“¡ (`unit_staff`) - å³ä½¿æ˜¯å…¨çƒè™•ä¹Ÿä¸è¡Œ

---

## ğŸ§ª æ¸¬è©¦å»ºè­°

### 1. æ¸¬è©¦ç®¡ç†å“¡åŠŸèƒ½
- [ ] å‰µå»º unit_staff å¸³è™Ÿï¼ˆæœ‰ unit_idï¼‰
- [ ] å‰µå»º auditor å¸³è™Ÿï¼ˆç„¡ unit_idï¼‰
- [ ] æ›´æ–°ä½¿ç”¨è€…è§’è‰²
- [ ] é‡è¨­ä½¿ç”¨è€…å¯†ç¢¼
- [ ] åˆªé™¤ä½¿ç”¨è€…ï¼ˆä¸èƒ½åˆªé™¤è‡ªå·±ï¼‰

### 2. æ¸¬è©¦å–®ä½è·å“¡æ¬Šé™
- [ ] å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å­¸ç”Ÿè³‡æ–™
- [ ] åªèƒ½ä¸Šå‚³æ‰€å±¬å–®ä½çš„æ–‡ä»¶
- [ ] ç„¡æ³•æ›´æ–°æ–‡ä»¶ç‹€æ…‹
- [ ] ç„¡æ³•å­˜å–å ±è¡¨é é¢

### 3. æ¸¬è©¦ç¨½æ ¸äººå“¡æ¬Šé™
- [ ] å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å­¸ç”Ÿè³‡æ–™
- [ ] å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶
- [ ] å¯ä»¥æ›´æ–°æ–‡ä»¶ç‹€æ…‹
- [ ] å¯ä»¥æŸ¥çœ‹å’ŒåŒ¯å‡ºå ±è¡¨
- [ ] ç„¡æ³•ä¸Šå‚³æ–‡ä»¶
- [ ] ç„¡æ³•ä¿®æ”¹å­¸ç”Ÿè³‡æ–™

---

## ğŸ“¦ ä¿®æ”¹çš„æª”æ¡ˆæ¸…å–®

### å¾Œç«¯
- âœ… `backend/src/models/user.ts` - ç§»é™¤ STUDENT è§’è‰²ï¼Œæ–°å¢æ¬Šé™æ–¹æ³•
- âœ… `backend/src/controllers/user.controller.ts` - æ–°å»ºä½¿ç”¨è€…ç®¡ç†æ§åˆ¶å™¨
- âœ… `backend/src/services/user.service.ts` - æ–°å»ºä½¿ç”¨è€…ç®¡ç†æœå‹™
- âœ… `backend/src/routes/user.routes.ts` - æ–°å»ºä½¿ç”¨è€…ç®¡ç†è·¯ç”±
- âœ… `backend/src/index.ts` - æ•´åˆä½¿ç”¨è€…è·¯ç”±

### å‰ç«¯
- âœ… `frontend/src/pages/StudentDetailPage.tsx` - æ›´æ–°å¯©æ ¸æ¬Šé™åˆ¤æ–·
- âœ… `frontend/src/components/Navigation.tsx` - æ›´æ–°å°èˆªé¸å–®é‚è¼¯

### æ–‡æª”
- âœ… `ROLE_SYSTEM_UPDATE_SUMMARY.md` - æœ¬æ–‡æª”

---

## ğŸš€ éƒ¨ç½²æ­¥é©Ÿ

1. **é‡å•Ÿå¾Œç«¯ä¼ºæœå™¨**
   ```bash
   docker compose restart backend
   # æˆ–
   npm run dev:backend
   ```

2. **æª¢æŸ¥æ—¥èªŒ**
   ```bash
   docker logs fsvs-backend --tail 50
   ```
   æ‡‰è©²çœ‹åˆ°ï¼š`ä½¿ç”¨è€…ç®¡ç†ç«¯é»: http://localhost:5000/api/users`

3. **æ¸¬è©¦ API**
   ```bash
   # å–å¾—ä½¿ç”¨è€…åˆ—è¡¨ï¼ˆéœ€è¦ç®¡ç†å“¡ tokenï¼‰
   curl http://localhost:5001/api/users \
     -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
   ```

4. **å‰ç«¯ç„¡éœ€é‡æ–°ç·¨è­¯**
   - å‰ç«¯ä¿®æ”¹æœƒè‡ªå‹•ç†±é‡è¼‰

---

## âœ… å®Œæˆç‹€æ…‹

- âœ… 1. åˆªé™¤å­¸ç”Ÿè§’è‰²
- âœ… 2. ç®¡ç†å“¡å¯ä»¥ç®¡ç†ä½¿ç”¨è€…å¸³è™Ÿ
- âœ… 3. å–®ä½è·å“¡æ¬Šé™èª¿æ•´
- âœ… 4. ç¨½æ ¸äººå“¡æ¬Šé™èª¿æ•´

æ‰€æœ‰ä¿®æ”¹å·²å®Œæˆä¸¦é€šéç·¨è­¯æª¢æŸ¥ï¼
