# 系統角色與權限說明

## 📋 系統角色

系統共有 **4 個角色**：

### 1. 👨‍💼 系統管理員 (Admin)
**角色代碼**: `admin`  
**中文名稱**: 系統管理員

**權限**：
- ✅ 完整系統存取權限
- ✅ 可以存取所有單位的資料
- ✅ 可以管理所有使用者
- ✅ 可以更新文件狀態（審核功能）
- ✅ 可以查看所有報表和統計
- ✅ 可以修改系統設定
- ✅ 可以觸發排程任務

### 2. 👔 單位職員 (Unit Staff)
**角色代碼**: `unit_staff`  
**中文名稱**: 單位職員

**權限**：
- ✅ 可以上傳所屬單位負責的文件類型
- ✅ 可以查看所屬單位的學生資料
- ✅ 可以查看所屬單位的文件
- ⚠️ 只能存取自己單位的資料
- ❌ 無法存取其他單位的資料
- ❌ 無法修改系統設定

**單位範例**：
- 全球處 (global_affairs)
- 註冊組 (registration)
- 實就組 (internship)
- 外語中心 (language_center)
- 宿輔組 (dormitory)
- 等等...

### 3. 🔍 稽核人員 (Auditor)
**角色代碼**: `auditor`  
**中文名稱**: 稽核人員

**權限**：
- ✅ 可以查看所有單位的資料（唯讀）
- ✅ 可以查看所有學生的文件
- ✅ 可以查看追蹤記錄和稽核報表
- ✅ 可以匯出報表
- ⚠️ 主要用於監督和查核
- ❌ 無法上傳或修改文件
- ❌ 無法修改系統設定

### 4. 👨‍🎓 學生 (Student)
**角色代碼**: `student`  
**中文名稱**: 學生

**權限**：
- ✅ 可以查看自己的資料
- ✅ 可以查看自己的文件上傳狀況
- ✅ 可以查看文件完成度
- ❌ 無法上傳文件（由各單位職員上傳）
- ❌ 無法查看其他學生的資料
- ❌ 無法存取報表功能

---

## 🗺️ 頁面存取權限

### 所有角色都可存取的頁面

| 頁面 | 路徑 | 說明 |
|------|------|------|
| 🏠 首頁 | `/` | 系統首頁和概覽 |
| 👥 學生管理 | `/students` | 學生列表（根據角色顯示不同範圍） |
| 👤 學生詳情 | `/students/:id` | 個別學生的詳細資料和文件 |
| 🔔 通知 | `/notifications` | 系統通知和提醒 |

### 角色專屬頁面

#### 系統管理員 (Admin) 專屬
| 頁面 | 路徑 | 說明 |
|------|------|------|
| 📊 報表統計 | `/reports` | 儀表板、稽核報表、追蹤記錄 |
| ⚙️ 系統設定 | `/settings` | 系統配置和參數設定 |
| 📄 文件管理 | `/documents` | 所有文件的管理介面 |

#### 單位職員 (Unit Staff)
| 頁面 | 路徑 | 說明 |
|------|------|------|
| 📄 文件管理 | `/documents` | 所屬單位的文件管理 |

#### 稽核人員 (Auditor)
| 頁面 | 路徑 | 說明 |
|------|------|------|
| 📊 報表統計 | `/reports` | 查看報表和追蹤記錄（唯讀） |
| 📄 文件管理 | `/documents` | 查看所有文件（唯讀） |

#### 學生 (Student)
- 只能存取基本頁面
- 無專屬頁面

---

## 🎯 功能權限矩陣

### 學生管理功能

| 功能 | Admin | Unit Staff | Auditor | Student |
|------|-------|------------|---------|---------|
| 查看學生列表 | ✅ 全部 | ✅ 所屬單位 | ✅ 全部 | ❌ |
| 查看學生詳情 | ✅ | ✅ | ✅ | ✅ 自己 |
| 新增學生 | ✅ | ✅ | ❌ | ❌ |
| 編輯學生資料 | ✅ | ✅ 所屬單位 | ❌ | ❌ |
| 刪除學生 | ✅ | ❌ | ❌ | ❌ |

### 文件管理功能

| 功能 | Admin | Unit Staff | Auditor | Student |
|------|-------|------------|---------|---------|
| 上傳文件 | ✅ 全部類型 | ✅ 所屬單位類型 | ❌ | ❌ |
| 查看文件 | ✅ | ✅ | ✅ | ✅ 自己的 |
| 下載文件 | ✅ | ✅ | ✅ | ✅ 自己的 |
| 刪除文件 | ✅ | ✅ 自己上傳的 | ❌ | ❌ |
| **更新文件狀態** | ✅ | ❌ | ❌ | ❌ |
| 審核文件 | ✅ | ❌ | ❌ | ❌ |

### 報表功能

| 功能 | Admin | Unit Staff | Auditor | Student |
|------|-------|------------|---------|---------|
| 查看儀表板 | ✅ | ❌ | ✅ | ❌ |
| 查看稽核報表 | ✅ | ❌ | ✅ | ❌ |
| 查看追蹤記錄 | ✅ | ❌ | ✅ | ❌ |
| 匯出報表 | ✅ | ❌ | ✅ | ❌ |

### 系統管理功能

| 功能 | Admin | Unit Staff | Auditor | Student |
|------|-------|------------|---------|---------|
| 管理使用者 | ✅ | ❌ | ❌ | ❌ |
| 系統設定 | ✅ | ❌ | ❌ | ❌ |
| 查看系統日誌 | ✅ | ❌ | ✅ | ❌ |
| 觸發排程任務 | ✅ | ❌ | ❌ | ❌ |

---

## 🔐 特殊權限說明

### 文件狀態更新權限

根據 `StudentDetailPage.tsx` 的實作：

```typescript
const canUpdateStatus = user?.role === 'admin' || 
                       user?.role === 'reviewer' || 
                       user?.unit_id === 'global_affairs';
```

可以更新文件狀態的角色：
1. ✅ **系統管理員** (`admin`)
2. ✅ **審核人員** (`reviewer`) - 注意：這是前端定義的角色，後端使用 `auditor`
3. ✅ **全球處職員** (`unit_id === 'global_affairs'`)

### 單位別文件類型權限

每個單位只能上傳特定類型的文件：

| 單位 | 可上傳的文件類型 |
|------|------------------|
| 全球處 | 招生規定、招生簡章、招生網頁、華語能力證明、英文能力證明、財力證明、錄取通知單、入學法規切結書、獎助學金 |
| 註冊組 | 畢業證書、中五生、歷年成績單、學雜費收退費基準 |
| 實就組 | 學生實習合約、畢業流向 |
| 外語中心 | 華語師資 |
| 宿輔組 | 宿舍 |
| 各系所學程 | 各系所中英文對照學分時數表 |

---

## 📝 角色使用情境

### 情境 1：全球處職員上傳文件
1. 以 `unit_staff` 角色登入（unit_id: `global_affairs`）
2. 進入學生詳情頁面
3. 可以上傳全球處負責的文件類型
4. **可以更新文件狀態**（因為是全球處）

### 情境 2：註冊組職員上傳文件
1. 以 `unit_staff` 角色登入（unit_id: `registration`）
2. 進入學生詳情頁面
3. 只能上傳註冊組負責的文件類型
4. **無法更新文件狀態**（不是全球處或管理員）

### 情境 3：管理員審核文件
1. 以 `admin` 角色登入
2. 進入學生詳情頁面
3. 可以查看所有文件
4. 點擊「更新狀態」按鈕
5. 選擇狀態：待審核 → 已核准/已拒絕

### 情境 4：稽核人員查看報表
1. 以 `auditor` 角色登入
2. 進入報表頁面
3. 可以查看儀表板、稽核報表、追蹤記錄
4. 可以匯出報表
5. 無法修改任何資料

### 情境 5：學生查看自己的資料
1. 以 `student` 角色登入
2. 只能看到自己的學生詳情頁面
3. 可以查看文件上傳狀況和完成度
4. 無法上傳或修改文件
5. 無法存取其他學生的資料

---

## 🔄 角色變更流程

管理員可以變更使用者角色：

```typescript
user.changeRole(UserRole.UNIT_STAFF, 'global_affairs');
// 將使用者變更為全球處職員

user.changeRole(UserRole.ADMIN);
// 將使用者變更為管理員（會清除單位關聯）
```

**注意事項**：
- 變更為 `unit_staff` 時必須指定 `unit_id`
- 變更為其他角色時會自動清除 `unit_id`
- 角色變更會立即生效

---

## 🎨 前端導航選單顯示邏輯

根據 `Navigation.tsx` 的實作：

```typescript
// 所有角色都能看到
- 首頁
- 學生管理
- 通知

// 非學生角色可以看到
if (user?.role !== 'student') {
  - 文件管理
}

// 管理員和單位主管可以看到
if (user?.role === 'admin' || user?.role === 'unit_manager') {
  - 報表統計
}

// 只有管理員可以看到
if (user?.role === 'admin') {
  - 系統設定
}
```

**注意**：前端代碼中使用了 `unit_manager` 角色，但後端沒有定義此角色。建議統一使用後端定義的 `auditor` 角色。

---

## ⚠️ 注意事項

1. **角色不一致問題**：
   - 前端使用 `reviewer` 和 `unit_manager`
   - 後端定義 `auditor`
   - 建議統一為後端的角色定義

2. **權限檢查**：
   - 前端和後端都需要進行權限檢查
   - 前端檢查用於 UI 顯示
   - 後端檢查用於安全防護

3. **單位關聯**：
   - `unit_staff` 角色必須有 `unit_id`
   - 其他角色不需要 `unit_id`

4. **文件狀態更新**：
   - 目前只有管理員和全球處可以更新
   - 如需擴展權限，需修改 `StudentDetailPage.tsx` 的 `canUpdateStatus` 邏輯
